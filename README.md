# Example application based on HAPI

This is a simple API for managing todo tasks. This application is based
on [hapi](http://hapijs.com) framework and is supposed
to serve as an example of a typical REST API implementation. I've tried to
incorporate elements that could be used in real life applications. This example
could be particularly useful if you have already learned the basics of hapi
and struggling to build up an application "the right way".

---
## Application structure

This application consists of two major parts:

- API.
- Web interface for managing API access (to be implemented).

API part is based mostly on recommendations outlined in
[Best Practices for Designing a Pragmatic RESTful
API](http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api).
It uses a simple auth scheme with
a [bearer token](https://github.com/johnbrett/hapi-auth-bearer-token).
The token is generated for every registered API user and can be obtained
through the web interface (to be done).
A more secure and flexible authentication scheme can be implemented using
[JWT](https://github.com/dwyl/learn-json-web-tokens).

Since all interactions with a storage backend is done through
[Sequelize ORM](http://sequelizejs.com) there are several DBMS to choose from.
Though the es6 features like `let` and `const` (but no `class` - to be done),
the autogenerated file models/index.js includes `var` syntax.

All the test specifications use Mocha and Chai with BDD assertion style. Though
the [Lab](https://github.com/hapijs/lab) package can be used as an alternative.

This application is configured to run under
[node-foreman](https://github.com/strongloop/node-foreman). See below
for details.

### API endpoints

URI|HTTP method|Description
---|-----------|-----------
/tasks|GET|List all todo items
/tasks/{taskId}|GET|Get a single todo item
/tasks/{taskId}|DELETE|Delete a single todo item
/tasks/{taskId}|PATCH|Update a single todo item
/tasks|POST|Create a new todo item

### Application folders and files

```
.
├── .gitignore
├── .jscsrc - Javascript code style checker configuration
├── .jshintrc - Javascript linter configuration
├── .sequelizerc - Sequelize.js configuration
├── LICENSE.md
├── Procfile - process list to run by node-foreman
├── Procfile.dev.example - Example
├── README.md
├── example.env - Example .env file for the node-foreman
├── example.testenv - Example .testenv file for node-foreman for running tests
├── nodemon.json - Nodemon package configuration
├── package.json
├── src - Application code
│   ├── api - API code
│   │   ├── controllers - Controller modules
│   │   │   └── task.js
│   │   ├── helpers - Various supporting modules
│   │   │   ├── auth-validate.js
│   │   │   └── pagination.js
│   │   ├── index.js - Application main module
│   │   └── routes - Routes configuration modules
│   │       ├── index.js
│   │       └── tasks.js
│   ├── config - Application configuration files
│   │   ├── application.js
│   │   └── db.js
│   ├── migrations - Sequelize.js database migrations
│   │   ├── 20160115130727-create-user.js
│   │   └── 20160115131210-create-task.js
│   ├── models - Sequelize.js data models
│   │   ├── index.js - This file is generated by Sequelize CLI
│   │   ├── task.js
│   │   └── user.js
│   ├── seeders - Dummy data generators for tests
│   └── web - Web interface code (to be done)
└── test - Mocha tests and supporting files
    ├── api - Test specifications for API part of the application
    │   ├── task.spec.js
    │   └── tasks.spec.js
    ├── common.js - Globals definition for use in tests
    ├── helpers.js - Helper methods for use in tests
    ├── mocha.opts - Mocha configuration options
    └── web - Test specifications for the web part of the application
```

## package.json

### Packages

Here's the brief description of some packages:

- `chalk`: add colors to console output,
- `hapi-auth-bearer-token`: simple token-based authentication plugin,
- `joi`: validation plugin,
- `sequelize`: Sequelize ORM,
- `chai`: assertion library for Mocha,
- `chai-as-promised`: promise-based version of chai,
- `foreman`: process manager,
- ``

### NPM scripts

There are two blocks to pay attention to:

- config,
- scripts.

`config` section describes a reusable value in the scripts section. In this
application it's like an overhead, but in complex projects it could be
useful.

The `scripts` section is inspired by a blog post:
[How to Use npm as a Build Tool](http://blog.keithcirkel.co.uk/how-to-use-npm-as-a-build-tool/).
The idea here is to get by without tools like [gulp](http://gulpjs.com)
and [grunt](http://gruntjs.com).

Note the `start` and `start:dev` scripts definitions and the use of the config
section reference to swap the configuration value. The reference syntax
isn't really consistent, but it's still can be used to build complex
expressions.

The particular script can be run using `npm run <script>` command.

## Environment settings

The common practice is to use environment variables to pass the configuration
values to an application: database connection strings etc. Since the application
is started using `node-foreman` module `.env` and `.testenv` files are used
to provide specific values for the application configurations files.
`node-foreman` uses `.env` file by default, but it can be overwritten
with a command line parameter. Look at the `test` script definition
in the `package.json` file for an example.

## Getting up and running

`node-foreman` module uses `Procfile` files to describe what processes should
be launched. For example it can start a process for the API server and another
for the web server, e.g. interface for managing API users.

`node-foreman` provides a PORT environment variable which can be used
in the application configuration file as described in its
[documentation](https://github.com/strongloop/node-foreman#advanced-usage).

Since `.env` files contain sensible information like passwords they shouldn't
be checked into version control. So **to launch the application** you should
create your own `.env` and `.testenv` files based on provided examples
(`example.env` and `example.testenv`).

- Run `npm start` to launch the application.
- Run `npm run start:dev` to launch the application under `nodemon` so it
will reload each time a source file is changed.

## Tests

There's a `test` script defined in the `package.json` file. Don't forget
to create a test database and put credentials into `.testenv` file.

Run `npm test` to launch Mocha tests.

There's a `test/helpers.js` script which contains an `api` function
definition. It uses `inject` method to query the api instead of regular HTTP
requests. This is a method recommended by
[hapi documentation](http://hapijs.com/api#serverinjectoptions-callback).

## Moving to production

There are many ways to deploy Node.js application to production environments.
Here are some examples:

- use `node-foreman` `export` command to generate `upstart` scripts so the
application could be started at the server boot,
- use a tool like [PM2](http://pm2.keymetrics.io).

The latter one gives more advantages, including monitoring, deployment workflow.
It could also be used for the development workflow instead of `node-foreman`.

I would also like to mention [Docker](http://docker.com) as a solution for both
the development and production workflows though it requires some learning
and setup.

## License

[MIT (c) 2016 Artem Krivtsov](./LICENSE.md)
